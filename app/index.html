<!doctype html>
<html>
<head>
    <link rel="stylesheet" href="css/app.css" type="text/css">
    <link rel="stylesheet" href="css/page.css" type="text/css">
    <link rel="stylesheet" href="css/list-bare.css" type="text/css">
    <link rel="stylesheet" href="css/animate.css" type="text/css">
    <link rel="stylesheet" href="css/utils.css" type="text/css">
</head>
<body>

	<ul class="oPage_list">
		<li id="Page0" class="oPage isActive uCenter">
        	<img class="oPage_logo" src="images/logo.png" />

        	<small>V 5.0.0</small>

        	<h1>Texte Liturgice Ortodoxe</h1>

        	<small>de la</small>

        	<div class="oPage_link">www.teologie.net</div>
        </li>

		<li id="Page1" class="oPage">
			<div class="oPage_hero">
				<img src="images/christ_icon.jpg" />
			</div>

			<h2 id="AppTitle" class="oPage_header fillMain">Texte Liturgice Ortodoxe</h2>

			<ul id="MainBooks" class="oListBare"></ul>
		</li>

        <li id="Page2" class="oPage">
            <h2 id="ChapterTitle" class="oPage_header fillMain"></h2>

            <ul id="ChapterBooks" class="oListBare"></ul>
        </li>

  </ul>

<!-- -------------------------------------- -->

<script type="text/javascript">

    var DONE = 4; // readyState 4 means the request is done.
    var OK = 200; // status 200 is a successful return.

	var elPageIndex    = document.getElementById('Page0');
	var elPageHome     = document.getElementById('Page1');
    var elPageChapter  = document.getElementById('Page2');
    var elMainBooks    = document.getElementById('MainBooks');

    var pagesList = [];
    var mainBooks = [];

    function changePage (elPageCurrent, elPageNew, fnCallback) {
        elPageCurrent.classList.add('animated');
        elPageCurrent.classList.add('slideOutLeft');
        elPageNew.classList.add('animated');
        elPageNew.classList.add('slideInRight');
        elPageNew.classList.add('isActive');

        setTimeout(function () {
            elPageCurrent.classList.remove('animated');
            elPageCurrent.classList.remove('slideOutLeft');
            elPageCurrent.classList.remove('isActive');
            elPageCurrent.classList.add('isRendered');
            elPageNew.classList.remove('animated');
            elPageNew.classList.remove('slideInRight');

            if (typeof(fnCallback) == "function") {
                fnCallback.call();
            }
        }, 1000);

        if (pagesList.length == 0) {
            pagesList.push(elPageCurrent);
        }

        pagesList.push(elPageNew);
    }

    function backPage () {
        var elPageCurrent = pagesList[pagesList.length - 1];
        var elPagePrev;

        if (pagesList.length > 2) {
            elPageCurrent.classList.add('animated');
            elPageCurrent.classList.add('slideOutRight');

            elPagePrev = pagesList[pagesList.length - 2];
            elPagePrev.classList.remove('isRendered');
            elPagePrev.classList.add('animated');
            elPagePrev.classList.add('slideInLeft');
            elPagePrev.classList.add('isActive');

            setTimeout(function () {
                elPageCurrent.classList.remove('isActive');
                elPageCurrent.classList.remove('animated');
                elPageCurrent.classList.remove('slideOutRight');
                elPagePrev.classList.remove('slideInLeft');
            }, 1000);

        } else {
            alert("Exit APP");
        }

        pagesList.pop();
    }

    function addBook (currentBook, index, elParent) {
        var elItem = document.createElement("li");
        var elCheckbox = document.createElement("input");
        var elLbl = document.createElement('label');
        var elGroup = document.createElement('div');
        var text = document.createTextNode(currentBook.title);
        var wait = (index + 1) * 300;
        var type = 'Root';
        var hasChildren = false;
        var elList;
        var id = "Book_" + currentBook.id;
        var idBox = id +  "_box";
        var animEffect = 'bounceInRight';


        elCheckbox.setAttribute('type', 'checkbox');
        elCheckbox.className = 'oListBare_box';

        elGroup.className = 'oListBare_group';
        elGroup.appendChild(elLbl);

        elLbl.appendChild(text);
        elLbl.className = 'oListBare_lbl';

        elItem.setAttribute('id', id);
        elItem.className = 'oListBare_item';
        elItem.appendChild(elCheckbox);
        elItem.appendChild(elGroup);

        if (typeof(elParent) == 'undefined') {
            elParent = elMainBooks;
        } else {
            type = 'Secondary';
            idBox = type + idBox;
            // wait = 0;
            animEffect = 'fadeIn';
        }

        elCheckbox.setAttribute('id', idBox);
        elLbl.setAttribute('for', idBox);
        elLbl.setAttribute('data-book', currentBook.id);
        elLbl.classList.add('fill' + type);
        elLbl.classList.add(animEffect);
        elLbl.classList.add('animated');

        if (typeof(currentBook.books) != 'undefined' && currentBook.books.length) {
            elList = document.createElement('ul');
            elList.className = 'oListBare_children';
            elGroup.appendChild(elList);

            elLbl.classList.add('hasChildren');
            hasChildren = true;
        } else {
            elLbl.addEventListener('click', bookClicked);
        }

        setTimeout(function () {
            elParent.appendChild(elItem);

            if (hasChildren) {
                for (var i = 0; i < currentBook.books.length; i++) {
                    addBook(currentBook.books[i], i, elList);
                }
            }
        }, wait);
    }

    function listBooks () {
        var elChapterTitle = document.getElementById('AppTitle');

        elChapterTitle.addEventListener('click', backPage);

        for (var i = 0; i < mainBooks.length; i++) {
            addBook(mainBooks[i], i);
        }
    }

    function listChaper (chapterBooks, parentBookId) {
        var elChapterTitle = document.getElementById('ChapterTitle');
        var elChapterBooks = document.getElementById('ChapterBooks');
        var elParentBook   = document.getElementById('Book_' + parentBookId);
        var elParentLabel  = elParentBook.getElementsByTagName('label')[0];

        elChapterTitle.addEventListener('click', backPage);
        elChapterTitle.textContent = elParentLabel.textContent;

        for (var i = 0; i < chapterBooks.length; i++) {
            addBook(chapterBooks[i], i, elChapterBooks);
        }
    }

    function bookClicked () {
        var bookId = this.getAttribute('data-book');
        var bookUrl = 'books/' + bookId + '.json'
        var xhr = new XMLHttpRequest();
        xhr.open('GET', bookUrl);
        xhr.send(null);
        console.log("Request " + bookUrl);

        xhr.onreadystatechange = function () {
            if (xhr.readyState === DONE) {
                var chapterBooks = [];

                if (xhr.status === OK) {
                  console.log("Received data");
                  console.log(xhr.responseText); // 'This is the returned text.'
                  chapterBooks = JSON.parse(xhr.responseText);
                } else {
                  console.log('Error: ' + xhr.status); // An error occurred during the request.
                }

                setTimeout( function () {
                    changePage(elPageHome, elPageChapter, function () { listChaper(chapterBooks, bookId); });
                }, 200);
            }
        };
    }

	document.addEventListener('DOMContentLoaded', function() {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', 'books.json');
        xhr.send(null);

        xhr.onreadystatechange = function () {
            if (xhr.readyState === DONE) {
                if (xhr.status === OK) {
                  mainBooks = JSON.parse(xhr.responseText);
                } else {
                  console.log('Error: ' + xhr.status); // An error occurred during the request.
                }

                setTimeout( function () {
                    changePage(elPageIndex, elPageHome, listBooks);
                }, 200);
            }
        };
    });

</script>

</body>
</html>